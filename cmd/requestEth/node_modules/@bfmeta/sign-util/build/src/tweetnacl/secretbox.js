"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports._onetimeauth = exports.secretbox_open = exports.secretbox = void 0;
const array_1 = require("./array");
const verify_1 = require("./verify");
const salsa20_1 = require("./salsa20");
const poly1305_1 = require("./poly1305");
const check_1 = require("./check");
function secretbox(msg, nonce, key) {
    (0, check_1.checkArrayTypes)(msg, nonce, key);
    (0, check_1.checkLengths)(key, nonce);
    const m = new array_1.ByteArray(32 /* SecretBoxLength.Zero */ + msg.length);
    const c = new array_1.ByteArray(m.length);
    for (let i = 0; i < msg.length; i++)
        m[i + 32 /* SecretBoxLength.Zero */] = msg[i];
    _secretbox(c, m, m.length, nonce, key);
    return c.subarray(16 /* SecretBoxLength.Overhead */);
}
exports.secretbox = secretbox;
function secretbox_open(box, nonce, key) {
    (0, check_1.checkArrayTypes)(box, nonce, key);
    (0, check_1.checkLengths)(key, nonce);
    const c = new array_1.ByteArray(16 /* SecretBoxLength.Overhead */ + box.length);
    const m = new array_1.ByteArray(c.length);
    for (let i = 0; i < box.length; i++)
        c[i + 16 /* SecretBoxLength.Overhead */] = box[i];
    if (c.length < 32 /* SecretBoxLength.Zero */ || _secretbox_open(m, c, c.length, nonce, key) !== 0)
        return;
    return m.subarray(32 /* SecretBoxLength.Zero */);
}
exports.secretbox_open = secretbox_open;
// low level
function _secretbox(c, m, d, n, k) {
    if (d < 32)
        return -1;
    (0, salsa20_1._stream_xor)(c, 0, m, 0, d, n, k);
    _onetimeauth(c, 16, c, 32, d - 32, c);
    for (let i = 0; i < 16; i++)
        c[i] = 0;
    return 0;
}
function _secretbox_open(m, c, d, n, k) {
    const x = new array_1.ByteArray(32);
    if (d < 32)
        return -1;
    (0, salsa20_1._stream)(x, 0, 32, n, k);
    if (_onetimeauth_verify(c, 16, c, 32, d - 32, x) !== 0)
        return -1;
    (0, salsa20_1._stream_xor)(m, 0, c, 0, d, n, k);
    for (let i = 0; i < 32; i++)
        m[i] = 0;
    return 0;
}
function _onetimeauth(out, outpos, m, mpos, n, k) {
    const s = (0, poly1305_1.poly1305_init)(k);
    (0, poly1305_1.poly1305_update)(s, m, mpos, n);
    (0, poly1305_1.poly1305_finish)(s, out, outpos);
    return 0;
}
exports._onetimeauth = _onetimeauth;
function _onetimeauth_verify(h, hpos, m, mpos, n, k) {
    const x = new array_1.ByteArray(16);
    _onetimeauth(x, 0, m, mpos, n, k);
    return (0, verify_1._verify_16)(h, hpos, x, 0);
}
//# sourceMappingURL=secretbox.js.map